name: Capture Screenshots

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    # Only trigger on manual request or specific label
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      dark_mode:
        description: 'Capture dark mode screenshots'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: capture-screenshots-${{ github.ref }}
  cancel-in-progress: true

jobs:
  capture-ios-screenshots:
    name: Capture iOS Screenshots
    runs-on: macos-14
    # Only run on push to main, manual trigger, or PRs with 'screenshots' label
    if: |
      github.event_name == 'push' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'screenshots'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Install fastlane
      run: |
        # Install fastlane if not already installed
        if ! command -v fastlane &> /dev/null; then
          brew install fastlane
        fi
        fastlane --version
    
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-xcode15-v1
        restore-keys: |
          ${{ runner.os }}-spm-xcode15-
          ${{ runner.os }}-spm-
    
    - name: Install dependencies
      run: swift package resolve
    
    - name: Build for testing
      run: |
        xcodebuild build-for-testing \
          -scheme CubeSolver \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          -derivedDataPath .build/DerivedData \
          | xcpretty || true
    
    - name: Run UI tests and capture screenshots
      run: |
        xcodebuild test-without-building \
          -scheme CubeSolver \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
          -derivedDataPath .build/DerivedData \
          -resultBundlePath .build/TestResults.xcresult \
          | xcpretty || true
      continue-on-error: true
    
    - name: Extract screenshots from test results
      run: |
        # Create screenshots directory
        mkdir -p docs/images/screenshots
        
        # Extract screenshots from xcresult bundle
        if [ -d ".build/TestResults.xcresult" ]; then
          echo "Found test results bundle, extracting screenshots..."
          
          # Export attachments using xcresulttool
          TEMP_DIR=$(mktemp -d)
          xcrun xcresulttool export \
            --type directory \
            --path .build/TestResults.xcresult \
            --output-path "$TEMP_DIR" 2>/dev/null || true
          
          # Find and copy screenshots
          if [ -d "$TEMP_DIR" ]; then
            find "$TEMP_DIR" -type f \( -name "*.png" -o -name "*.jpg" \) -exec cp {} docs/images/screenshots/ \; 2>/dev/null || true
            rm -rf "$TEMP_DIR"
          fi
          
          # Fallback: Find and copy any .png files from DerivedData
          find .build/DerivedData -name "*.png" -exec cp {} docs/images/screenshots/ \; 2>/dev/null || true
          
          echo "Screenshots extracted to docs/images/screenshots/"
          ls -la docs/images/screenshots/ || echo "No screenshots found"
        else
          echo "No test results bundle found"
        fi
    
    - name: Generate screenshots with fastlane (if configured)
      if: success() && false  # Disabled by default, enable when ready
      run: |
        cd fastlane
        fastlane ios screenshots
      continue-on-error: true
    
    - name: Upload screenshots as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-screenshots
        path: |
          docs/images/screenshots/
          fastlane/screenshots/
          .build/TestResults.xcresult
        retention-days: 30
    
    - name: Create screenshots summary
      if: always()
      run: |
        echo "## üì∏ Screenshots Captured" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "docs/images/screenshots" ] && [ "$(ls -A docs/images/screenshots)" ]; then
          echo "### UI Test Screenshots" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for img in docs/images/screenshots/*.png; do
            if [ -f "$img" ]; then
              filename=$(basename "$img")
              echo "- \`$filename\`" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "‚ö†Ô∏è No screenshots were captured from UI tests" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Commit screenshots to repository
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add screenshots
        git add docs/images/screenshots/ || true
        
        # Commit if there are changes
        if ! git diff --staged --quiet; then
          git commit -m "Update screenshots from UI tests [skip ci]"
          git push
          echo "‚úÖ Screenshots committed to repository"
        else
          echo "‚ÑπÔ∏è No new screenshots to commit"
        fi

  capture-macos-screenshots:
    name: Capture macOS Screenshots
    runs-on: macos-14
    # Only run on push to main, manual trigger, or PRs with 'screenshots' label
    if: |
      github.event_name == 'push' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'screenshots'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'
    
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-xcode15-v1
        restore-keys: |
          ${{ runner.os }}-spm-xcode15-
          ${{ runner.os }}-spm-
    
    - name: Install dependencies
      run: swift package resolve
    
    - name: Build for macOS
      run: |
        xcodebuild build \
          -scheme CubeSolver \
          -destination 'platform=macOS' \
          -derivedDataPath .build/DerivedData \
          | xcpretty || true
      continue-on-error: true
    
    - name: Capture macOS screenshot (manual)
      run: |
        mkdir -p docs/images/macos
        echo "üìù Note: macOS screenshots require manual capture or UI testing setup"
        echo "To capture macOS screenshots:"
        echo "1. Run the app on macOS"
        echo "2. Use Cmd+Shift+4 or screencapture tool"
        echo "3. Save to docs/images/macos/"
    
    - name: Upload macOS build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: .build/DerivedData/Build/Products/
        retention-days: 7
