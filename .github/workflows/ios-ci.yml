name: iOS CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  lint:
    name: SwiftLint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Run SwiftLint
      uses: norio-nomura/action-swiftlint@3.2.1
      with:
        args: --strict
      env:
        DIFF_BASE: ${{ github.base_ref }}

  build-and-test:
    name: Build and Test
    runs-on: macos-14
    needs: lint
    strategy:
      matrix:
        xcode: ['15.2', '15.3']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ matrix.xcode }}
    
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    
    - name: Install Swift dependencies
      run: swift package resolve
      
    - name: Build Swift package
      run: swift build
      
    - name: Run tests
      run: swift test --enable-code-coverage --parallel
      
    - name: Generate code coverage report
      if: matrix.xcode == '15.2'
      run: |
        # Find all test executables and generate coverage for each
        for test_exec in .build/debug/*.xctest/Contents/MacOS/*; do
          if [ -f "$test_exec" ]; then
            xcrun llvm-cov export -format="lcov" \
              "$test_exec" \
              -instr-profile .build/debug/codecov/default.profdata >> coverage.lcov 2>/dev/null || true
          fi
        done
      
    - name: Upload coverage to Codecov
      if: matrix.xcode == '15.2'
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.lcov
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        
    - name: Check code coverage threshold
      if: matrix.xcode == '15.2'
      run: |
        # Extract coverage percentage (basic check)
        if [ -f coverage.lcov ]; then
          echo "Coverage report generated successfully"
        else
          echo "Warning: No coverage report generated"
        fi
